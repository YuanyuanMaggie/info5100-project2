<html>
  <head>
    <title>Cornell Graduates</title>
    
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

    <link rel="stylesheet" href="site.css">
    
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="//d3js.org/topojson.v1.min.js"></script>
    <script src="http://d3js.org/d3.geo.projection.v0.min.js" charset="utf-8"></script>
    <script src="https://d3js.org/d3-queue.v1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.6.7/d3-tip.js"></script>

    <script
        src="https://code.jquery.com/jquery-1.12.3.min.js"
        integrity="sha256-aaODHAgvwQW1bFOGXMeX+pC4PZIPsvn2h1sArYOhgXQ="
        crossorigin="anonymous">
    </script>

    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

    <script src="colorbrewer.min.js"></script>

  </head>
  <body>
    <div class="container">

      <div class="row">
        <div class="col-lg-12">
          <h2>Cornell Graduates - Regional and State Comparisons</h2>
        </div>
      </div>
      <div class="row">
        <div class="col-lg-3">
          <div class="btn-group" data-toggle="buttons">
            <label class="btn btn-default active">
              <input type="radio" id="radio-focus" name="focus" value="state" autocomplete="off" checked> State
            </label>
            <label class="btn btn-default">
              <input type="radio" id="radio-focus" name="focus" value="region" autocomplete="off"> Region
            </label>
          </div>
        </div>
        <div class="col-lg-1">
          <label for="slider text-right"><span id="year">Year</span></label>
        </div>
        <div class="col-lg-4">
          <input type="range" min="2001" max="2014" value="2014" id="slider-year" step="1" >
        </div>
      </div>
      <div class="row bottom-margin">
        <div class="col-lg-8">
          <div id="maps"></div>
          <div id="legend"></div>
        </div>
        <div class="col-lg-4">
          <div id="details" class="jumbotron">
            <p id="intro">As graduation approaches, every Cornell senior has an important decision to make: which job to pick. With graduation coming up quickly in May, we thought we could take this opportunity to delve deeper into what Cornell students have received as their starting salaries as they step out into the real world. We hope this visualization helps graduating seniors students in their decision making process about potential job opportunities.</p>
            <h3 class='no-top-margin'>
              <span id="focus"></span>
              <span id="focus-year" class="pull-right"></span>
            </h3>
            <ul class="data-details list-unstyled"></ul>
          </div>
        </div>
      </div>

      <div class="row bottom-margin">

        <div class="col-lg-12">
          <h2>Cornell Graduates - Starting Salaries By College</h2>
        </div>

        <div class="col-lg-9">
          <div id="timeline"></div>
        </div>
        <div class="col-lg-3">
            <input type="hidden" id="year-loan" value='2014'></input>
            <label id="slider">Loan Paid as Percent of Salary  : <span id="percent">20%</span></label>
            <input type="range" min="0.2" max="1" value="0.2" id="slider-percent" step="0.01" >
          <div id="barchart"></div>
        </div>

      </div>
    
    </div>

    <script>

    var formatPercent = d3.format('.0%')
    var formatCurrency = d3.format("$,.0f");
    var formatIndex = d3.format(".0f");
    var formatRound = d3.format(".0f");

    //show year as input changes
    $('input[id="slider-year"]').on("input", function() {
      $('#year').html(this.value);
    });

    $('input[id="slider-percent"]').on("input", function() {
      formatPercent($('#percent').html(this.value));
    });


    var maps = 
      [
        {
          id: 'Cornell', 
          type: 'salary',
          title: 'Starting Salary of Cornell Graduates',
          showMap: true
        },
        {
          id: 'AdjForCost',
          type: 'salary',
          title: 'Salary Adjusted by Cost of Living',
          showMap: false
        },
        {
          id: 'Salary',  
          type: 'salary',
          title: 'Salary Per Capita',
          showMap: true
        },
        {
          id: 'Rent', 
          type: 'rent',
          title: 'Housing (Rental) Costs',
          showMap: true
        },
        {
          id: 'CostIndex',
          type: 'cost',
          title: 'Cost of Living Index',
          showMap: true
        }
      ];


    var vis = (function(d3) {
        var geojson;
        queue()
          .defer(d3.json, 'states.topojson')
          .defer(d3.csv, 'dataByState.csv')
          .defer(d3.csv, 'dataByRegion.csv')
          .await(visualize);

        var width = 370,
            height = 250;

        var projection = d3.geo.mercator()
          .center([-95.35,39.50])
          .scale(350)
          .translate([width / 2, height / 2]);

        var path = d3.geo.path().projection(projection);

        //setup scales and ranges
        //show legend once for each
        var salaryColors = createLegend([30000,75000], colorbrewer.Greens[9], 'salary');
        var costColors = createLegend([50,170], colorbrewer.Purples[6], 'cost');
        var rentColors = createLegend([500,1500], colorbrewer.Reds[5], 'rent');

        function visualize(error, dataGeo, dataByState, dataByRegion) {

          maps.forEach( function (map)
          {
            if (map.showMap) {
              createMap(map.id, map.title, map.type, dataGeo, dataByState, dataByRegion);
            }
          });

        }

        function createLegend(domain, colorScale, type) {

          var colors = d3.scale.quantize()
            .domain(domain)
            .range(colorScale);

          var legend = d3.select('#legend')
            .append('ul')
            .attr('class', 'list-inline');

          var keys = legend.selectAll('li.key')
              .data(colors.range());

          keys.enter().append('li')
              .attr('class', 'key')
              .style('border-top-color', String)
              .text(function(d) {
                  // return color.invertExtent(d);
                  var r = colors.invertExtent(d);
                  if (type == 'cost') {
                    return formatIndex(r[0]);
                  } else {
                    return formatCurrency(r[0]);
                  }

              });

          return colors;
        }

        function createMap(id, title, type, shapes, dataState, dataRegion) {

          var map = d3.select('#maps').append("svg")
            .attr("class", "map")
            .attr("width", width)
            .attr("height", height);

            map.append("text")
            .attr('class','title')
            .attr("x", width/2)
            .attr("y", 30)
            .attr("text-anchor", "middle")
            .text(title);

          var geography = topojson.feature(shapes,shapes.objects.states).features;

          var geoPaths = map.append("g");
          geoPaths.selectAll("path").data(geography).enter()
            .append("path")
            .attr("d", path)
            .attr("class", "state")
            .attr("data-state", function(d) { return d.properties.abbr })
            .attr("data-region", function(d) { return d.properties.region });

          if (type == 'salary') {
            var colors = salaryColors;
          } else if (type == 'cost') {
            var colors = costColors;
          } else {
            var colors = rentColors;
          }

          var dataByRegion = d3.map(dataRegion, function (d) { return d.Region; });
          var dataByState = d3.map(dataState, function (d) { return d.State; });

          function updateMaps() {
            
            var year = $('input[id="slider-year"]').val();
            var focus = $('input[type="radio"]:checked').val();

            geoPaths.selectAll("path")
              .style("fill", function (d) {

              // map data to geography
              if (focus == 'region') {
                var filteredData = dataByRegion.get(d.properties.region);
              } else {
                var filteredData = dataByState.get(d.properties.name);
              }
      
              if (! filteredData) { return "#e2e2e2";}
              return colors(filteredData[id + year]);
            })
              .on('mouseover', function(d, i) {

                // map data to geography
                if (focus == 'region') {
                  var filteredData = dataByRegion.get(d.properties.region);
                  $('#focus').html(d.properties.region);

                  var highlight = d3.select(this).attr('data-region');
                  d3.selectAll('[data-region="' + highlight + '"]')
                    .style({'fill-opacity':.5});
                } else {
                  var filteredData = dataByState.get(d.properties.name);
                  $('#focus').html(d.properties.name);
  
                  var highlight = d3.select(this).attr('data-state');
                  d3.selectAll('[data-state="' + highlight + '"]')
                    .style({'fill-opacity':.5});
                }                  
                
                // $('#year').html(year);
                var list = '';
                maps.forEach(function (map) {
                  if (map.type == 'cost') {
                    var dataPoint = formatIndex(filteredData[map.id + year]);
                  } else {
                    var dataPoint = formatCurrency(filteredData[map.id + year]);
                  }
                  list += '<li>' + map.title + ': <strong>' + dataPoint + '</strong></li>';
                });
                $('p#intro').css('display', 'none');
                $('#focus-year').html(year);
                $('ul.data-details').html(list);
              })
              .on('mouseout', function(d) {
                if (focus == 'region') {
                  var highlight = d3.select(this).attr('data-region');
                  d3.selectAll('[data-region="' + highlight + '"]')
                    .style({'fill-opacity':1});
                } else {
                  var highlight = d3.select(this).attr('data-state');
                  d3.selectAll('[data-state="' + highlight + '"]')
                    .style({'fill-opacity':1});
                }
                $('p#intro').css('display', 'block');
                $('#focus').html('');
                $('#focus-year').html('');
                $('ul.data-details').html('');
              });
            }

            //listeners
            $('input[id="slider-year"]').on("input", updateMaps);
            $('input[type="radio"]').on('click change', updateMaps);

            //initialize
            updateMaps();

          }
        

    })(d3);

    function createTimeline() {
      
      var margin = {top: 30, right: 300, bottom: 30, left: 60},
          width = 878 - margin.left - margin.right,
          height = 400 - margin.top - margin.bottom;

      var marginBar = {top: 30, right: 0, bottom: 30, left: 25},
          widthBar = 292 - marginBar.left - marginBar.right,
          heightBar = 300 - marginBar.top - marginBar.bottom;

      var formatCurrency = d3.format("$,.0f");

      var parseYear = d3.time.format("%Y").parse;

      //for timeline
      var x = d3.time.scale().range([0, width]);
      var y = d3.scale.log().range([height, 0]);

      var color = d3.scale.category10();

      //years
      var xAxis = d3.svg.axis().scale(x)
          .orient("bottom").ticks(14);

      //salary/currency (tuition)
      var yAxis = d3.svg.axis().scale(y)
          .orient("left").ticks(5).tickFormat(function(d) { return formatCurrency(d); });

      var line = d3.svg.line()
        .x(function(d) { return x(d.year); })
        .y(function(d) { return y(d.salary); });

      var timeline = d3.select("#timeline")
        .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
        .append("g")
            .attr("transform", 
                  "translate(" + margin.left + "," + margin.top + ")");

      //for barchart
      var xBar = d3.scale.ordinal()
          .rangeRoundBands([0, widthBar], .2);

      var yBar = d3.scale.linear()
          .domain([0,50])
          .range([heightBar, 0]);

      //years
      var yAxisBar = d3.svg.axis()
          .scale(yBar)
          .orient("left")
          .ticks(5);

      var barchart = d3.select("#barchart").append("svg")
          .attr("width", widthBar + marginBar.left + marginBar.right)
          .attr("height", heightBar + marginBar.top + marginBar.bottom)
        .append("g")
          .attr("transform", "translate(" + marginBar.left + "," + marginBar.top + ")");

      barchart.append("g")
          .attr("class", "y axis")
          .call(yAxisBar)
        .append("text")
          .attr("transform", "rotate(-90)")
          .attr("y", 6)
          .attr("dy", ".71em")
          .style("text-anchor", "end")
          .text("Years");


      // DATA for salaries by college
      d3.csv('salariesByCollegeAndTuition.csv', function(error, data) {
        
        color.domain(d3.keys(data[0]).filter(function(key) { 
          if (key !== "Year") {
            return key; 
          }
        }));

        x.domain(d3.extent(data, function(d) { return parseYear(d.Year); }));
        y.domain([30000,200000]);

        var salaryByCollege = color.domain().map(function(college) {
          return {
            college: college,
            values: data.map(function(d) {
              return {year: parseYear(d.Year), salary: +d[college]};
            })
          };
        });

        var colleges = d3.keys(data[0]).filter(function(key) {
          if (key !== "Year" && key !== "Tuition") {
            return key;
          }
        });

        var years = [];
        var dataRemapped = [];

        data.forEach(function(d) {
          colleges.forEach(function(college) {
            dataRemapped.push(
              {
                'college':college,
                'year': d.Year,
                'salary': d[college]
              }
            );
            if (years.indexOf(d.Year) < 0) { 
              years.push(d.Year);
            }
          });
        });

        timeline.append("g")            
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);
          
        timeline.append("g")
            .attr("class", "y axis")
            .call(yAxis);

        timeline.selectAll(".year")
            .data(years)
          .enter().append("rect")
            .attr("class", "year")
            .attr("id", function(d) { return d.toString(); })
            .attr("x", function(d) { return x(parseYear(d)) - 20; })
            .attr("width", 40)
            .attr("y", 0 )
            .attr("height", height)
          .on("mouseover",function(d){
            d3.select(this).style('fill-opacity',.5);
            d3.select(this).classed('active', true);
            $('#year-loan').val(d3.select(this).attr("id"));
            updateBarChart();
            // tip.show(d);
          })
          .on("mouseout",function(d){
            d3.select(this).style('fill-opacity',0);
            d3.select(this).classed('active', false);
            // tip.hide(d);
          });
      

        //trend line
        var trendLines = timeline.selectAll(".lines")
            .data(salaryByCollege)
          .enter().append("g")
            .attr("class", "lines");

        trendLines.append("path")
            .attr("class", "trendline")
            .attr("id",function(d){
              var college = d.college.replace(/ +/g, "").replace(/\(([^)]+)\)/);
              return college})
            .attr("d", function(d) { return line(d.values); })
            .style("stroke", function(d) { return color(d.college); });

        // var tip = d3.tip()
        //        .attr('class', 'd3-tip')
        //         .offset([-10, 0])
        //         .html(function(salaryDataMapped) {
        //           return "<strong>Salary :</strong> <span style='color:red'>$" + d.salary + "</span><br><strong>College:</strong> <span style='color:red'>" + d.name + "</span>";
        //            });

        //timeline.call(tip);
        //trend circle

        //display data point
        timeline.selectAll(".datapoints")
            .data(dataRemapped)
          .enter().append("circle")
            .attr("class", "datapoint")
            .attr("cx",function(d){return x(parseYear(d.year)); })
            .attr("cy",function(d){return y(d.salary); })
            .attr("r",4)
            .style({'fill-opacity':1})
            .style("fill", function(d) { return color(d.college); });

        // //for mouseover effect
        // timeline.selectAll(".datapoints")
        //     .data(dataRemapped)
        //   .enter().append("circle")
        //     .attr("class", "datapoint")
        //     .attr("cx",function(d){return x(parseYear(d.year)); })
        //     .attr("cy",function(d){return y(d.salary)})
        //     .attr("r",10)
        //     .style('fill-opacity',0)
        //     .style("fill", function(d) { return color(d.college); })
        //   .on("mouseover",function(d){
        //     d3.select(this).style('fill-opacity',1);
        //     // tip.show(d);
        //   })
        //   .on("mouseout",function(d){
        //     d3.select(this).style('fill-opacity',0);
        //     // tip.hide(d);
        //   });
       
        // add legend   
        var legend = timeline.append("g")
          .attr("class", "legend")
          .attr("height", 100)
          .attr("width", 100)
          .attr('transform', 'translate(-20,0)');    
          
          legend.selectAll('circle')
              .data(salaryByCollege)
            .enter()
              .append("circle")
              .attr("cx", width + margin.left)
              .attr("cy", function(d, i){return i * 20 + 5;})
              .attr("r", 4)
              .style("fill", function(d) { return color(d.college); });
              
          legend.selectAll('text')
              .data(salaryByCollege)
            .enter()
              .append("text")
              .attr("class", "label")
              .attr("id",function(d){ return d.college.replace(/ +/g, "") + "Label"; })
              .attr("x", width + margin.left + 10)
              .attr("y", function(d, i){ return i * 20 + 8;})
              .style("fill", function(d) { return color(d.college); })
              .text(function(d) { return d.college; })
            .on("mouseover",function(d){
                d3.select(this).style("font-size","1em");
                var college = "#"+d.college.replace(/ +/g, "").replace(/\(([^)]+)\)/);
                d3.selectAll(college).style("stroke-width","8px");
                d3.selectAll(college).style("fill-opacity",1);
            })
            .on("mouseout",function(d){
                d3.select(this).style("font-size","0.8em");
                var college = "#"+d.college.replace(/ +/g, "").replace(/\(([^)]+)\)/);
                d3.selectAll(college).style("stroke-width","3px");
                d3.selectAll(college).style("fill-opacity",.8);
            });


            //barchart

            //x-axis colleges

            color.domain(colleges);
            xBar.domain(colleges);

            var xAxisBar = d3.svg.axis()
              .scale(xBar)
              .orient("bottom")
              .tickFormat(function(d) { 
                if (d.match(/\(([^)]+)\)/)) {
                  return d.match(/\(([^)]+)\)/)[1].toString();
                } else {
                  return d;
                }
              });

            barchart.append("g")
              .attr("class", "x axis")
              .attr("transform", "translate(0," + heightBar + ")")
              .call(xAxisBar);

            function updateBarChart() {

              var rate = $('input[id="slider-percent"]').val();
              var year = $('#year-loan').val();

              dataFilteredByYear = data.filter(function(d) {
                return d['Year'] == year;
              });

              var debtByCollege = []; 
              //college: value,
              //debtInYears: value

              dataFilteredByYear.forEach(function(d) {
                colleges.forEach(function(college) {
                  if (college !== 'Tuition') {
                    debtByCollege.push(
                      {
                        'college':college,
                        'debtInYears':debtInYears(d['Tuition'], d[college], rate)
                      }
                    );
                  }
                });
              });

              var collegeBars = barchart.selectAll(".bar")
                .data(debtByCollege);
                
              collegeBars.enter().append('rect')
                .attr("class","bar");


              collegeBars.transition().duration(1000)
                .attr("id",function(d){ return d.college.replace(/ +/g, "").replace(/\(([^)]+)\)/); })
                .attr("x", function(d) { return xBar(d.college); })
                .attr("width", xBar.rangeBand())
                .attr("y", function(d) { return yBar(d.debtInYears); })
                .attr("height", function(d) { return heightBar - yBar(d.debtInYears); })
                .attr("fill", function(d) { return color(d.college); })
                .style("fill-opacity", .8);   


              var collegeBarsText = barchart.selectAll(".barlabel")
                .data(debtByCollege);
                
              collegeBarsText.enter().append('text')
                .attr("class","barlabel");
              
              collegeBarsText.transition().duration(2000)             
                // .append('text')
                .attr("dy", "1.5em")
                .attr("y", function(d) { return yBar(d.debtInYears); })
                .attr("x", function(d) { return xBar(d.college) +  xBar.rangeBand()/2; })
                .attr("text-anchor", "middle")
                .text(function (d) { return formatRound(d.debtInYears); });

            }

            //listener 
            $('input[id="slider-percent"]').on('change', updateBarChart);
            //initialize
            updateBarChart();


        }); 

      }

      //timeline 
      createTimeline();

          
      function debtInYears(tuition,salary,percent) {
        var temp = (0.0429*tuition)/(percent*salary);
        var years = (-Math.log(1-temp))/(Math.log(1+0.0429));
        return years;
      }

    </script>

  </body>
</html>